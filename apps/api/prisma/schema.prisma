// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}



datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // <-- C'est la ligne manquante
  // ... Le reste des commentaires peut Ãªtre laissÃ© ou retirÃ© ...
}

// ========================================
// MODÃˆLE UTILISATEUR AVEC RÃ”LES DÃ‰FINIS
// L'utilisateur est l'entitÃ© racine. Les autres tables le rÃ©fÃ©rencent.
// ========================================
model User {
  id          Int      @id @default(autoincrement())
  email       String   @unique
  password    String
  firstName   String
  lastName    String
  phone       String?
  role        UserRole @default(GUEST)
  isActive    Boolean  @default(true)

  // ðŸŸ¢ RELATIONS INVERSES: Permettent Ã  User de "voir" toutes les tables dÃ©pendantes
  studios     Studio[]      // Les studios possÃ©dÃ©s par cet utilisateur (ownerId)
  reservations Reservation[] // Les rÃ©servations faites par cet utilisateur (guestId)
  payments    Payment[]     // Les paiements effectuÃ©s par cet utilisateur (userId)

  // MÃ©tadonnÃ©es
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastLoginAt DateTime?

  @@map("users")
  @@index([email]) 
}

// ========================================
// MODÃˆLE STUDIO (DÃ‰PEND DE USER)
// ========================================
model Studio {
  id          Int      @id @default(autoincrement())
  name        String
  description String?

  // Localisation
  address     String
  city        String
  postalCode  String
  country     String   @default("France")

  // CaractÃ©ristiques
  surface     Float?   // en mÂ²
  capacity    Int      @default(2)
  bedrooms    Int      @default(1)
  bathrooms   Int      @default(1)

  // Prix et disponibilitÃ©
  pricePerNight Int    // en centimes d'euros
  isAvailable   Boolean @default(true)
  minStay       Int     @default(1) // nuits minimum
  maxStay       Int     @default(30) // nuits maximum

  // MÃ©dia et services
  photos        String[] // URLs des photos
  primaryPhoto  String?  // URL de la photo principale (premiÃ¨re Ã  afficher)
  amenities     String[] // ["wifi", "kitchen", "parking", etc.]
  rules         String[] // RÃ¨gles de la maison

  // ðŸŸ¢ PROPRIÃ‰TAIRE: RÃ©fÃ©rence l'utilisateur (dÃ©pendance)
  owner         User     @relation(fields: [ownerId], references: [id])
  ownerId       Int

  // MÃ©tadonnÃ©es
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  reservations  Reservation[]  
  @@map("studios")
}

// ========================================
// MODÃˆLE RÃ‰SERVATION (DÃ‰PEND DE USER)
// ========================================
model Reservation {
  id          Int               @id @default(autoincrement())

  // Dates de sÃ©jour
  checkIn     DateTime
  checkOut    DateTime
  nights      Int               // CalculÃ© automatiquement

  // Participants
  guestCount  Int               @default(1)

  // CoÃ»ts (en centimes)
  subtotal    Int              
  cleaningFee Int               @default(0)
  serviceFee  Int               @default(0)
  taxes       Int               @default(0)
  total       Int               

  // Statut de la rÃ©servation
  status      ReservationStatus @default(PENDING)

  // Informations additionnelles
  specialRequests String?
  cancelReason    String?
  cancelledAt     DateTime?

  // Relations
  studio      Studio  @relation(fields: [studioId], references: [id])
  studioId    Int
  // ðŸŸ¢ GUEST: RÃ©fÃ©rence l'utilisateur (dÃ©pendance)
  guest       User    @relation(fields: [guestId], references: [id])
  guestId     Int
  payments    Payment[]

  // MÃ©tadonnÃ©es
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("reservations")
  @@index([status]) 
}

// ========================================
// MODÃˆLE PAIEMENT (DÃ‰PEND DE USER ET RESERVATION)
// ========================================
model Payment {
  id            Int           @id @default(autoincrement())

  // Montant et devise
  amount        Int           // en centimes
  currency      String        @default("EUR")

  // Informations de paiement
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)

  // RÃ©fÃ©rences externes (Stripe, PayPal, etc.)
  externalId    String?       // ID du processeur de paiement
  externalData  Json?         // DonnÃ©es supplÃ©mentaires du processeur

  // Gestion des erreurs
  failureReason String?
  refundAmount  Int?          @default(0)
  refundReason  String?
  refundedAt    DateTime?

  // Relations
  reservation   Reservation   @relation(fields: [reservationId], references: [id])
  reservationId Int
  // ðŸŸ¢ USER: RÃ©fÃ©rence l'utilisateur (dÃ©pendance)
  user          User          @relation(fields: [userId], references: [id])
  userId        Int

  // MÃ©tadonnÃ©es
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  processedAt   DateTime?

  @@map("payments")
  @@index([status]) 
}

// ========================================
// Ã‰NUMÃ‰RATIONS (ENUMS)
// ========================================
enum UserRole {
  GUEST      
  ADMIN      
  SUPER_ADMIN 

  @@map("user_roles")
}

enum ReservationStatus {
  PENDING    
  CONFIRMED  
  CANCELLED  
  COMPLETED  
  NO_SHOW    

  @@map("reservation_statuses")
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  PAYPAL
  BANK_TRANSFER
  APPLE_PAY
  GOOGLE_PAY
  PAWAPAY

  @@map("payment_methods")
}

enum PaymentStatus {
  PENDING    
  PROCESSING 
  COMPLETED  
  FAILED     
  REFUNDED   
  CANCELLED  

  @@map("payment_statuses")
}

// ========================================
// MODÃˆLE TOKEN DE RÃ‰INITIALISATION DE MOT DE PASSE
// ========================================
model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  email     String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("password_reset_tokens")
  @@index([token])
  @@index([email])
}