// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ========================================
// MOD√àLE UTILISATEUR AVEC R√îLES D√âFINIS
// L'utilisateur est l'entit√© racine. Les autres tables le r√©f√©rencent.
// ========================================
model User {
  id          Int      @id @default(autoincrement())
  email       String   @unique
  password    String
  firstName   String
  lastName    String
  phone       String?
  role        UserRole @default(GUEST)
  isActive    Boolean  @default(true)

  // üü¢ RELATIONS INVERSES: Permettent √† User de "voir" toutes les tables d√©pendantes
  studios     Studio[]      // Les studios poss√©d√©s par cet utilisateur (ownerId)
  reservations Reservation[] // Les r√©servations faites par cet utilisateur (guestId)
  payments    Payment[]     // Les paiements effectu√©s par cet utilisateur (userId)

  // M√©tadonn√©es
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastLoginAt DateTime?

  @@map("users")
  @@index([email]) 
}

// ========================================
// MOD√àLE STUDIO (D√âPEND DE USER)
// ========================================
model Studio {
  id          Int      @id @default(autoincrement())
  name        String
  description String?

  // Localisation
  address     String
  city        String
  postalCode  String
  country     String   @default("France")

  // Caract√©ristiques
  surface     Float?   // en m¬≤
  capacity    Int      @default(2)
  bedrooms    Int      @default(1)
  bathrooms   Int      @default(1)

  // Prix et disponibilit√©
  pricePerNight Int    // en centimes d'euros
  isAvailable   Boolean @default(true)
  minStay       Int     @default(1) // nuits minimum
  maxStay       Int     @default(30) // nuits maximum

  // M√©dia et services
  photos        String[] // URLs des photos
  amenities     String[] // ["wifi", "kitchen", "parking", etc.]
  rules         String[] // R√®gles de la maison

  // üü¢ PROPRI√âTAIRE: R√©f√©rence l'utilisateur (d√©pendance)
  owner         User     @relation(fields: [ownerId], references: [id])
  ownerId       Int

  // M√©tadonn√©es
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  reservations  Reservation[]  
  @@map("studios")
}

// ========================================
// MOD√àLE R√âSERVATION (D√âPEND DE USER)
// ========================================
model Reservation {
  id          Int               @id @default(autoincrement())

  // Dates de s√©jour
  checkIn     DateTime
  checkOut    DateTime
  nights      Int               // Calcul√© automatiquement

  // Participants
  guestCount  Int               @default(1)

  // Co√ªts (en centimes)
  subtotal    Int              
  cleaningFee Int               @default(0)
  serviceFee  Int               @default(0)
  taxes       Int               @default(0)
  total       Int               

  // Statut de la r√©servation
  status      ReservationStatus @default(PENDING)

  // Informations additionnelles
  specialRequests String?
  cancelReason    String?
  cancelledAt     DateTime?

  // Relations
  studio      Studio  @relation(fields: [studioId], references: [id])
  studioId    Int
  // üü¢ GUEST: R√©f√©rence l'utilisateur (d√©pendance)
  guest       User    @relation(fields: [guestId], references: [id])
  guestId     Int
  payments    Payment[]

  // M√©tadonn√©es
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("reservations")
  @@index([status]) 
}

// ========================================
// MOD√àLE PAIEMENT (D√âPEND DE USER ET RESERVATION)
// ========================================
model Payment {
  id            Int           @id @default(autoincrement())

  // Montant et devise
  amount        Int           // en centimes
  currency      String        @default("EUR")

  // Informations de paiement
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)

  // R√©f√©rences externes (Stripe, PayPal, etc.)
  externalId    String?       // ID du processeur de paiement
  externalData  Json?         // Donn√©es suppl√©mentaires du processeur

  // Gestion des erreurs
  failureReason String?
  refundAmount  Int?          @default(0)
  refundReason  String?
  refundedAt    DateTime?

  // Relations
  reservation   Reservation   @relation(fields: [reservationId], references: [id])
  reservationId Int
  // üü¢ USER: R√©f√©rence l'utilisateur (d√©pendance)
  user          User          @relation(fields: [userId], references: [id])
  userId        Int

  // M√©tadonn√©es
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  processedAt   DateTime?

  @@map("payments")
  @@index([status]) 
}

// ========================================
// √âNUM√âRATIONS (ENUMS)
// ========================================
enum UserRole {
  GUEST      
  ADMIN      
  SUPER_ADMIN 

  @@map("user_roles")
}

enum ReservationStatus {
  PENDING    
  CONFIRMED  
  CANCELLED  
  COMPLETED  
  NO_SHOW    

  @@map("reservation_statuses")
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  PAYPAL
  BANK_TRANSFER
  APPLE_PAY
  GOOGLE_PAY
  PAWAPAY

  @@map("payment_methods")
}

enum PaymentStatus {
  PENDING    
  PROCESSING 
  COMPLETED  
  FAILED     
  REFUNDED   
  CANCELLED  

  @@map("payment_statuses")
}